<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - Halyk HR Forum</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- TensorFlow.js for AI Proctoring -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0/dist/tf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/blazeface@0.0.7/dist/blazeface.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/face-landmarks-detection@1.0.2/dist/face-landmarks-detection.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1DB584 0%, #0a7d5a 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .camera-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            border: 2px solid #e53e3e;
        }

        .camera-feed {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 320px;
            height: 240px;
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.3);
            z-index: 1001;
            overflow: hidden;
            border: 4px solid #e53e3e;
            background: #000;
            display: none;
        }

        .camera-feed.active {
            display: block;
        }

        .camera-feed video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1); /* Mirror effect */
        }

        .camera-status {
            position: absolute;
            bottom: 10px;
            left: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .camera-error {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #ffe0e0;
            color: #c41e3a;
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1002;
            max-width: 320px;
            border: 2px solid #c41e3a;
            display: none;
        }

        .camera-error.show {
            display: block;
        }

        .timer-display {
            position: fixed;
            top: 280px;
            right: 20px;
            background: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            border: 2px solid #1DB584;
        }

        .timer-display.warning {
            border-color: #ff9800;
            animation: shake 0.5s;
        }

        .timer-display.danger {
            border-color: #e53e3e;
            animation: shake 0.5s infinite;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        .timer-icon {
            font-size: 24px;
        }

        .timer-text {
            font-size: 24px;
            font-weight: 700;
            color: #333;
            font-family: 'Courier New', monospace;
        }

        .timer-text.warning {
            color: #ff9800;
        }

        .timer-text.danger {
            color: #e53e3e;
        }

        .timer-label {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        .camera-icon {
            font-size: 24px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .camera-text {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }

        .recording-dot {
            width: 10px;
            height: 10px;
            background: #e53e3e;
            border-radius: 50%;
            animation: blink 1.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        #root {
            max-width: 900px;
            margin: 0 auto;
        }

        .test-container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .progress {
            margin-bottom: 30px;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #1DB584;
            transition: width 0.3s;
        }

        .progress-text {
            margin-top: 8px;
            color: #666;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }

        .competencies-stats {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
        }

        .competencies-stats h3 {
            color: #333;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .competency-stat {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .competency-stat:last-child {
            border-bottom: none;
        }

        .competency-name {
            color: #666;
            font-size: 14px;
        }

        .competency-progress {
            font-weight: 600;
            color: #1DB584;
            font-size: 14px;
        }

        .question {
            margin-bottom: 30px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .question-number {
            color: #1DB584;
            font-weight: 600;
            font-size: 18px;
        }

        .question-level {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .question-level.Junior {
            background: #4caf50;
            color: white;
        }

        .question-level.Middle {
            background: #ff9800;
            color: white;
        }

        .question-level.Senior {
            background: #f44336;
            color: white;
        }

        .question-text {
            font-size: 20px;
            color: #333;
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .topic-name {
            font-size: 14px;
            color: #666;
            margin-bottom: 16px;
            padding: 8px 12px;
            background: #f0fdf7;
            border-left: 3px solid #1DB584;
            border-radius: 4px;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .option {
            padding: 16px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 16px;
        }

        .option:hover {
            border-color: #1DB584;
            background: #f0fdf7;
        }

        .option.selected {
            border-color: #1DB584;
            background: #1DB584;
            color: white;
        }

        .btn {
            width: 100%;
            padding: 16px;
            background: #1DB584;
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 24px;
        }

        .btn:hover {
            background: #16a073;
            transform: translateY(-2px);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .loading {
            text-align: center;
            padding: 60px;
            color: #666;
        }

        .completion {
            text-align: center;
            padding: 40px;
        }

        .completion h2 {
            color: #1DB584;
            margin-bottom: 20px;
            font-size: 32px;
        }

        .score-display {
            font-size: 64px;
            font-weight: 700;
            color: #1DB584;
            margin: 30px 0;
        }

        .level-badge {
            display: inline-block;
            padding: 12px 32px;
            background: #1DB584;
            color: white;
            border-radius: 30px;
            font-size: 24px;
            font-weight: 600;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <!-- Camera Feed -->
    <div class="camera-feed" id="cameraFeed">
        <video id="cameraVideo" autoplay playsinline muted></video>
        <div class="camera-status">
            <div class="recording-dot"></div>
            <span>üî¥ REC</span>
        </div>
    </div>

    <!-- Camera Error Message -->
    <div class="camera-error" id="cameraError">
        <strong>‚ö†Ô∏è –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ</strong>
        <p style="margin-top: 8px; font-size: 13px;">
            –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.
        </p>
    </div>

    <!-- Timer Display -->
    <div class="timer-display" id="timerDisplay">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <span class="timer-icon">‚è±Ô∏è</span>
            <span class="timer-text" id="timerText">40:00</span>
        </div>
        <div class="timer-label">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏</div>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // =====================================================
        // CAMERA STREAMING FUNCTIONALITY
        // =====================================================
        let cameraStream = null;

        async function startCamera() {
            console.log('üé• Attempting to start camera...');
            const videoElement = document.getElementById('cameraVideo');
            const cameraFeed = document.getElementById('cameraFeed');
            const cameraError = document.getElementById('cameraError');

            try {
                // Request camera access with specific constraints
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 640 },
                        height: { ideal: 480 },
                        facingMode: 'user'
                    },
                    audio: false
                });

                // Store stream reference for cleanup
                cameraStream = stream;

                // Attach stream to video element
                videoElement.srcObject = stream;

                // Show camera feed
                cameraFeed.classList.add('active');
                cameraError.classList.remove('show');

                console.log('‚úÖ Camera started successfully');
            } catch (error) {
                console.error('‚ùå Camera access error:', error);

                // Show error message
                cameraError.classList.add('show');
                cameraFeed.classList.remove('active');

                // Update error message based on error type
                const errorText = cameraError.querySelector('p');
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    errorText.textContent = '–î–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
                } else if (error.name === 'NotFoundError') {
                    errorText.textContent = '–ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –∫ –∫–æ–º–ø—å—é—Ç–µ—Ä—É –ø–æ–¥–∫–ª—é—á–µ–Ω–∞ –≤–µ–±-–∫–∞–º–µ—Ä–∞.';
                } else if (error.name === 'NotReadableError') {
                    errorText.textContent = '–ö–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã, –∏—Å–ø–æ–ª—å–∑—É—é—â–∏–µ –∫–∞–º–µ—Ä—É.';
                } else {
                    errorText.textContent = `–û—à–∏–±–∫–∞: ${error.message}`;
                }

                // Auto-hide error after 10 seconds
                setTimeout(() => {
                    cameraError.classList.remove('show');
                }, 10000);
            }
        }

        function stopCamera() {
            console.log('üõë Stopping camera...');
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            const videoElement = document.getElementById('cameraVideo');
            const cameraFeed = document.getElementById('cameraFeed');

            if (videoElement) {
                videoElement.srcObject = null;
            }
            if (cameraFeed) {
                cameraFeed.classList.remove('active');
            }

            console.log('‚úÖ Camera stopped');
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            stopCamera();
        });

        // =====================================================
        // AI PROCTORING - TENSORFLOW.JS
        // =====================================================
        let blazefaceModel = null;
        let faceLandmarksDetector = null;
        let proctoringInterval = null;
        let proctoringEnabled = false;
        let currentUserTestId = null;
        let lastFaceDetectionTime = Date.now();
        let noFaceWarningShown = false;
        let multipleFacesWarningShown = false;
        let tabSwitchCount = 0;
        let lastEventLog = {};

        // Load AI models
        async function loadAIModels() {
            console.log('ü§ñ Loading AI proctoring models...');
            try {
                // Load BlazeFace for face detection
                blazefaceModel = await blazeface.load();
                console.log('‚úÖ BlazeFace model loaded');

                // Load FaceMesh for facial landmarks (eye tracking)
                faceLandmarksDetector = await faceLandmarksDetection.createDetector(
                    faceLandmarksDetection.SupportedModels.MediaPipeFaceMesh,
                    {
                        runtime: 'tfjs',
                        maxFaces: 3,
                        refineLandmarks: true
                    }
                );
                console.log('‚úÖ FaceMesh model loaded');

                return true;
            } catch (error) {
                console.error('‚ùå Failed to load AI models:', error);
                return false;
            }
        }

        // Start AI proctoring
        async function startAIProctoring(userTestId) {
            if (proctoringEnabled) {
                console.log('‚ö†Ô∏è AI proctoring already running');
                return;
            }

            console.log('ü§ñ Starting AI proctoring for test:', userTestId);
            currentUserTestId = userTestId;
            proctoringEnabled = true;

            // Load models if not loaded
            if (!blazefaceModel || !faceLandmarksDetector) {
                const loaded = await loadAIModels();
                if (!loaded) {
                    console.error('‚ùå Cannot start proctoring: models failed to load');
                    return;
                }
            }

            // Run face detection every 2 seconds
            proctoringInterval = setInterval(async () => {
                if (!proctoringEnabled) return;
                await detectFaces();
            }, 3000);

            // Tab/window visibility detection
            document.addEventListener('visibilitychange', handleVisibilityChange);
            window.addEventListener('blur', handleWindowBlur);

            // Context menu detection (right-click)
            document.addEventListener('contextmenu', handleContextMenu);

            console.log('‚úÖ AI proctoring active with keyboard blocking');
        }

        // Stop AI proctoring
        function stopAIProctoring() {
            console.log('üõë Stopping AI proctoring');
            proctoringEnabled = false;

            if (proctoringInterval) {
                clearInterval(proctoringInterval);
                proctoringInterval = null;
            }

            document.removeEventListener('visibilitychange', handleVisibilityChange);
            window.removeEventListener('blur', handleWindowBlur);
            document.removeEventListener('contextmenu', handleContextMenu);

            console.log('‚úÖ AI proctoring stopped');
        }

        // Detect faces in video stream
        async function detectFaces() {
            if (!blazefaceModel || !proctoringEnabled) return;

            const videoElement = document.getElementById('cameraVideo');
            if (!videoElement || videoElement.readyState !== 4) return;

            try {
                // Detect faces with BlazeFace
                const predictions = await blazefaceModel.estimateFaces(videoElement, false);
                const faceCount = predictions.length;
                const now = Date.now();

                if (faceCount === 0) {
                    // No face detected
                    if (now - lastFaceDetectionTime > 5000) { // 5 seconds without face
                        if (!noFaceWarningShown) {
                            console.warn('‚ö†Ô∏è No face detected for 5+ seconds');
                            await logProctoringEvent('no_face_detected', 'high', {
                                duration: (now - lastFaceDetectionTime) / 1000,
                                message: 'Face disappeared from camera view'
                            });
                            noFaceWarningShown = true;
                        }
                    }
                } else {
                    // Face(s) detected
                    lastFaceDetectionTime = now;
                    noFaceWarningShown = false;

                    if (faceCount > 1) {
                        // Multiple faces detected
                        if (!multipleFacesWarningShown) {
                            console.warn(`‚ö†Ô∏è Multiple faces detected: ${faceCount}`);
                            await logProctoringEvent('multiple_faces', 'critical', {
                                face_count: faceCount,
                                message: 'More than one person detected in camera'
                            });
                            multipleFacesWarningShown = true;

                            // Show alert to user
                            setTimeout(() => {
                                alert('‚ö†Ô∏è –í–Ω–∏–º–∞–Ω–∏–µ! –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–∏—Ü –≤ –∫–∞–¥—Ä–µ. –í —Ç–µ—Å—Ç–µ –º–æ–∂–µ—Ç —É—á–∞—Å—Ç–≤–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫.');
                            }, 100);
                        }
                    } else {
                        multipleFacesWarningShown = false;
                    }

                    // Analyze eye gaze with FaceMesh (optional, more detailed)
                    if (faceLandmarksDetector && faceCount === 1) {
                        await analyzeEyeGaze(videoElement);
                    }
                }
            } catch (error) {
                console.error('Error detecting faces:', error);
            }
        }

        // Analyze eye gaze direction
        async function analyzeEyeGaze(videoElement) {
            try {
                const faces = await faceLandmarksDetector.estimateFaces(videoElement);

                if (faces.length > 0) {
                    const face = faces[0];
                    // Face mesh provides detailed landmarks for eye tracking
                    // This is a simplified version - full implementation would calculate
                    // eye gaze vectors from pupil positions relative to eye corners

                    // For now, we detect if face rotation is extreme
                    if (face.box) {
                        const rotation = calculateFaceRotation(face);
                        if (Math.abs(rotation) > 45) {
                            console.warn('‚ö†Ô∏è Face turned away from screen');
                            await logProctoringEvent('looking_away', 'medium', {
                                rotation: rotation,
                                message: 'Face orientation away from screen'
                            });
                        }
                    }
                }
            } catch (error) {
                console.error('Error analyzing eye gaze:', error);
            }
        }

        // Calculate face rotation (simplified)
        function calculateFaceRotation(face) {
            // Simplified rotation estimation from bounding box
            // Real implementation would use facial landmarks
            return 0; // Placeholder
        }

        // Handle tab switching / visibility change
        function handleVisibilityChange() {
            if (document.hidden && proctoringEnabled) {
                tabSwitchCount++;
                console.warn('‚ö†Ô∏è Tab switched or hidden', tabSwitchCount);
                logProctoringEvent('tab_switched', 'high', {
                    count: tabSwitchCount,
                    message: 'User switched to another tab or window'
                });
            }
        }

        // Handle window blur
        function handleWindowBlur() {
            if (proctoringEnabled) {
                console.warn('‚ö†Ô∏è Window lost focus');
                logProctoringEvent('window_blur', 'medium', {
                    message: 'Browser window lost focus'
                });
            }
        }

        // Handle context menu (right-click)
        function handleContextMenu(e) {
            if (proctoringEnabled) {
                e.preventDefault();
                console.warn('‚ö†Ô∏è Right-click detected');
                logProctoringEvent('context_menu', 'low', {
                    message: 'Right-click menu attempt'
                });
                alert('–ü—Ä–∞–≤—ã–π –∫–ª–∏–∫ –æ—Ç–∫–ª—é—á–µ–Ω –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è');
                return false;
            }
        }

        // Log proctoring event to backend
        async function logProctoringEvent(eventType, severity, details) {
            if (!currentUserTestId) return;

            // Throttle events - don't log same event within 30 seconds
            const now = Date.now();
            const lastLog = lastEventLog[eventType] || 0;
            if (now - lastLog < 30000) {
                return; // Skip duplicate events within 30 seconds
            }
            lastEventLog[eventType] = now;

            const token = sessionStorage.getItem('halyk_token');
            if (!token) return;

            try {
                const response = await fetch('/api/proctoring/event', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        user_test_id: currentUserTestId,
                        event_type: eventType,
                        severity: severity,
                        details: details
                    })
                });

                if (response.ok) {
                    console.log(`‚úÖ Logged event: ${eventType} (${severity})`);
                } else {
                    console.error('Failed to log proctoring event:', response.status);
                }
            } catch (error) {
                console.error('Error logging proctoring event:', error);
            }
        }

        // =====================================================
        // CRITICAL KEYBOARD BLOCKING (Ctrl+T, Ctrl+W)
        // =====================================================

        // Block critical keyboard shortcuts - SIMPLIFIED VERSION
        function blockCriticalShortcuts(e) {
            if (!proctoringEnabled) return;

            const key = e.key.toLowerCase();
            const ctrl = e.ctrlKey;
            const meta = e.metaKey; // Command key on Mac

            // Block Ctrl+T / Cmd+T (new tab) - CRITICAL
            if ((ctrl || meta) && key === 't') {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.warn('üö´ Blocked: Ctrl+T (new tab)');
                logProctoringEvent('new_tab_blocked', 'high', {
                    message: 'Attempted to open new tab with Ctrl+T'
                });
                return false;
            }

            // Block Ctrl+W / Cmd+W (close tab) - CRITICAL
            if ((ctrl || meta) && key === 'w') {
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation();
                console.warn('üö´ Blocked: Ctrl+W (close tab)');
                logProctoringEvent('close_tab_blocked', 'high', {
                    message: 'Attempted to close tab with Ctrl+W'
                });
                return false;
            }
        }

        // Prevent page unload/navigation
        function preventPageUnload(e) {
            if (!proctoringEnabled) return;

            e.preventDefault();
            e.returnValue = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É? –ü—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ—Å—Ç–∞ –±—É–¥–µ—Ç –ø–æ—Ç–µ—Ä—è–Ω.';
            return e.returnValue;
        }

        // Setup keyboard blocking
        function setupKeyboardBlocking() {
            // Block critical shortcuts - use capture phase for highest priority
            document.addEventListener('keydown', blockCriticalShortcuts, true);
            window.addEventListener('keydown', blockCriticalShortcuts, true);

            // Prevent page unload
            window.addEventListener('beforeunload', preventPageUnload);

            console.log('‚úÖ Critical keyboard shortcuts blocking active (Ctrl+T, Ctrl+W)');
        }

        // Cleanup keyboard blocking
        function cleanupKeyboardBlocking() {
            document.removeEventListener('keydown', blockCriticalShortcuts, true);
            window.removeEventListener('keydown', blockCriticalShortcuts, true);
            window.removeEventListener('beforeunload', preventPageUnload);

            console.log('‚úÖ Keyboard blocking cleaned up');
        }

        // Initialize on page load
        setupKeyboardBlocking();

        // =====================================================
        // REACT APP
        // =====================================================
        function App() {
            console.log('=== TEST APP LOADED - Self-Assessment Feature Active ===');

            const [questions, setQuestions] = useState([]);
            const [currentIndex, setCurrentIndex] = useState(0);
            const [selectedAnswer, setSelectedAnswer] = useState(null);
            const [loading, setLoading] = useState(true);
            const [completed, setCompleted] = useState(false);
            const [result, setResult] = useState(null);
            const [progress, setProgress] = useState(null);
            const [competencies, setCompetencies] = useState([]);
            const [selfRatings, setSelfRatings] = useState({});
            const [showSelfAssessment, setShowSelfAssessment] = useState(false);
            const [selfAssessmentSubmitted, setSelfAssessmentSubmitted] = useState(false);
            const [showCameraSetup, setShowCameraSetup] = useState(false);
            const [cameraReady, setCameraReady] = useState(false);
            const [faceDetected, setFaceDetected] = useState(false);
            const [cameraVerificationMessage, setCameraVerificationMessage] = useState('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...');
            const [isPaused, setIsPaused] = useState(false);
            const [pauseReason, setPauseReason] = useState('');
            const [faceCount, setFaceCount] = useState(0);
            const [isFullscreen, setIsFullscreen] = useState(false);
            const [timeRemaining, setTimeRemaining] = useState(40 * 60); // Will be updated from API
            const [timerExpired, setTimerExpired] = useState(false);
            const [timeLimitMinutes, setTimeLimitMinutes] = useState(40); // Default 40 minutes

            console.log('Initial state - showSelfAssessment:', false, 'competencies:', []);

            const urlParams = new URLSearchParams(window.location.search);
            const userTestId = urlParams.get('user_test_id');

            // Fullscreen helper functions
            const enterFullscreen = async () => {
                try {
                    const elem = document.documentElement;
                    if (elem.requestFullscreen) {
                        await elem.requestFullscreen();
                    } else if (elem.webkitRequestFullscreen) {
                        await elem.webkitRequestFullscreen();
                    } else if (elem.msRequestFullscreen) {
                        await elem.msRequestFullscreen();
                    }
                    console.log('‚úÖ Entered fullscreen mode');
                } catch (error) {
                    console.error('‚ùå Failed to enter fullscreen:', error);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–π—Ç–∏ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ F11 –∏–ª–∏ —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º.');
                }
            };

            // Monitor fullscreen changes
            useEffect(() => {
                const handleFullscreenChange = () => {
                    const isCurrentlyFullscreen = !!(
                        document.fullscreenElement ||
                        document.webkitFullscreenElement ||
                        document.msFullscreenElement
                    );

                    setIsFullscreen(isCurrentlyFullscreen);

                    // If test has started and user exits fullscreen, pause the test
                    if (selfAssessmentSubmitted && !showCameraSetup && !completed && !isCurrentlyFullscreen) {
                        console.log('‚ö†Ô∏è Exited fullscreen - pausing test');
                        setIsPaused(true);
                        setPauseReason('fullscreen');
                    } else if (isCurrentlyFullscreen && isPaused && pauseReason === 'fullscreen') {
                        // Resume if they return to fullscreen
                        console.log('‚úÖ Returned to fullscreen - resuming test');
                        setIsPaused(false);
                        setPauseReason('');
                    }
                };

                document.addEventListener('fullscreenchange', handleFullscreenChange);
                document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
                document.addEventListener('msfullscreenchange', handleFullscreenChange);

                return () => {
                    document.removeEventListener('fullscreenchange', handleFullscreenChange);
                    document.removeEventListener('webkitfullscreenchange', handleFullscreenChange);
                    document.removeEventListener('msfullscreenchange', handleFullscreenChange);
                };
            }, [selfAssessmentSubmitted, showCameraSetup, completed, isPaused, pauseReason]);

            useEffect(() => {
                // Load competencies FIRST for self-assessment
                loadCompetencies();
            }, []);

            useEffect(() => {
                // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—ã–π –Ω–µ–æ—Ç–≤–µ—á–µ–Ω–Ω—ã–π –≤–æ–ø—Ä–æ—Å
                if (questions.length > 0) {
                    const firstUnanswered = questions.findIndex(q => !q.is_answered);
                    if (firstUnanswered !== -1) {
                        setCurrentIndex(firstUnanswered);
                    }
                }
            }, [questions]);

            // Timer countdown effect - only starts AFTER self-assessment and pauses when test is paused
            useEffect(() => {
                if (!selfAssessmentSubmitted || completed || timerExpired || isPaused) return;

                const timer = setInterval(() => {
                    setTimeRemaining(prev => {
                        if (prev <= 1) {
                            clearInterval(timer);
                            setTimerExpired(true);
                            autoSubmitTest();
                            return 0;
                        }
                        return prev - 1;
                    });
                }, 1000);

                return () => clearInterval(timer);
            }, [selfAssessmentSubmitted, completed, timerExpired, isPaused]);

            // Update timer display
            useEffect(() => {
                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                const timeText = `${minutes}:${seconds.toString().padStart(2, '0')}`;

                const timerTextEl = document.getElementById('timerText');
                const timerDisplayEl = document.getElementById('timerDisplay');

                if (timerTextEl) {
                    timerTextEl.textContent = timeText;

                    // Add warning/danger classes
                    timerTextEl.classList.remove('warning', 'danger');
                    timerDisplayEl.classList.remove('warning', 'danger');

                    if (timeRemaining <= 60) {
                        timerTextEl.classList.add('danger');
                        timerDisplayEl.classList.add('danger');
                    } else if (timeRemaining <= 300) {
                        timerTextEl.classList.add('warning');
                        timerDisplayEl.classList.add('warning');
                    }
                }

                // Hide/show timer based on self-assessment status
                if (timerDisplayEl) {
                    timerDisplayEl.style.display = selfAssessmentSubmitted ? 'block' : 'none';
                }
            }, [timeRemaining, selfAssessmentSubmitted]);

            // Copy-paste prevention - only active AFTER self-assessment
            useEffect(() => {
                if (!selfAssessmentSubmitted) return;

                const preventCopy = (e) => {
                    e.preventDefault();
                    alert('–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞');
                    return false;
                };

                const preventPaste = (e) => {
                    e.preventDefault();
                    alert('–í—Å—Ç–∞–≤–∫–∞ –∑–∞–ø—Ä–µ—â–µ–Ω–∞ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞');
                    return false;
                };

                const preventCut = (e) => {
                    e.preventDefault();
                    alert('–í—ã—Ä–µ–∑–∞–Ω–∏–µ –∑–∞–ø—Ä–µ—â–µ–Ω–æ –≤–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞');
                    return false;
                };

                document.addEventListener('copy', preventCopy);
                document.addEventListener('paste', preventPaste);
                document.addEventListener('cut', preventCut);

                return () => {
                    document.removeEventListener('copy', preventCopy);
                    document.removeEventListener('paste', preventPaste);
                    document.removeEventListener('cut', preventCut);
                };
            }, [selfAssessmentSubmitted]);

            // üé• Stop camera and AI proctoring when test is completed
            useEffect(() => {
                if (completed) {
                    console.log('üõë Test completed - stopping camera monitoring and AI proctoring');
                    stopCamera();
                    stopAIProctoring();
                    cleanupKeyboardBlocking();
                }
            }, [completed]);

            const loadQuestions = async () => {
                const token = sessionStorage.getItem('halyk_token');
                if (!token) {
                    window.location.href = '/';
                    return;
                }

                try {
                    const response = await fetch(`/api/test/${userTestId}/questions`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const data = await response.json();

                    // Don't redirect - let test complete naturally to show self-assessment
                    console.log('üì• Questions loaded, progress:', data.progress);

                    setQuestions(data.questions);
                    setProgress(data.progress);

                    // Set time limit from API (convert minutes to seconds)
                    if (data.time_limit_minutes) {
                        const timeLimitSeconds = data.time_limit_minutes * 60;
                        setTimeLimitMinutes(data.time_limit_minutes);
                        setTimeRemaining(timeLimitSeconds);
                        console.log(`‚è±Ô∏è Test time limit: ${data.time_limit_minutes} minutes`);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤');
                } finally {
                    setLoading(false);
                }
            };

            const autoSubmitTest = async () => {
                const token = sessionStorage.getItem('halyk_token');
                try {
                    alert('‚è∞ –í—Ä–µ–º—è –≤—ã—à–ª–æ! –¢–µ—Å—Ç –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≤–µ—Ä—à–µ–Ω.');
                    const completeResponse = await fetch(`/api/complete-test/${userTestId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    const resultData = await completeResponse.json();
                    setResult(resultData);
                    setCompleted(true);
                } catch (error) {
                    console.error('Error auto-submitting test:', error);
                }
            };

            const handleAnswer = async () => {
                if (selectedAnswer === null || loading) return;

                setLoading(true);
                const token = sessionStorage.getItem('halyk_token');

                try {
                    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç
                    await fetch('/api/submit-answer', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            user_test_id: parseInt(userTestId),
                            question_id: questions[currentIndex].question_id,
                            user_answer: selectedAnswer
                        })
                    });

                    // –û–±–Ω–æ–≤–ª—è–µ–º –≤–æ–ø—Ä–æ—Å—ã –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å
                    await loadQuestions();

                    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≤–æ–ø—Ä–æ—Å—É –∏–ª–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ
                    if (currentIndex < questions.length - 1) {
                        setCurrentIndex(currentIndex + 1);
                        setSelectedAnswer(null);
                        setLoading(false);
                    } else {
                        // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ç–µ—Å—Ç–∞
                        const completeResponse = await fetch(`/api/complete-test/${userTestId}`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        const resultData = await completeResponse.json();
                        console.log('üéâ TEST COMPLETED! Setting completed=true, result:', resultData);
                        setResult(resultData);
                        setCompleted(true);
                        console.log('‚úÖ State updated - completed is now TRUE - useEffect should trigger!');
                        setLoading(false);
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–≤–µ—Ç–∞');
                    setLoading(false);
                }
            };

            const loadCompetencies = async () => {
                const token = sessionStorage.getItem('halyk_token');
                console.log('Loading competencies for test:', userTestId);
                try {
                    const response = await fetch(`/api/test/${userTestId}/top-competencies`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    console.log('Competencies response status:', response.status);
                    const data = await response.json();
                    console.log('Competencies data:', data);

                    if (data.status === 'success') {
                        console.log('Found', data.competencies.length, 'competencies');
                        setCompetencies(data.competencies);

                        // Check if self-assessment already submitted
                        if (data.already_submitted) {
                            console.log('Self-assessment already submitted, showing camera setup');
                            setSelfAssessmentSubmitted(true);
                            setShowSelfAssessment(false);
                            setLoading(false);

                            // Show camera setup for returning user
                            setShowCameraSetup(true);
                            await initializeCameraVerification();
                        } else {
                            console.log('Showing self-assessment form');
                            setShowSelfAssessment(true);
                            setLoading(false);
                        }
                    } else {
                        console.log('No competencies found or error in response');
                        setLoading(false);
                    }
                } catch (error) {
                    console.error('Error loading competencies:', error);
                    setLoading(false);
                }
            };

            const submitSelfAssessment = async () => {
                const token = sessionStorage.getItem('halyk_token');
                const assessments = Object.keys(selfRatings).map(compId => ({
                    competency_id: parseInt(compId),
                    self_rating: selfRatings[compId]
                }));

                if (assessments.length === 0) {
                    alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ü–µ–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—é');
                    return;
                }

                try {
                    const response = await fetch(`/api/test/${userTestId}/self-assessment`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({ assessments })
                    });
                    const data = await response.json();
                    if (data.status === 'success') {
                        setSelfAssessmentSubmitted(true);
                        setShowSelfAssessment(false);

                        // Show camera setup/verification screen
                        console.log('üì∏ Showing camera setup screen');
                        setShowCameraSetup(true);

                        // Initialize camera verification
                        await initializeCameraVerification();
                    }
                } catch (error) {
                    alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–∞–º–æ–æ—Ü–µ–Ω–∫–∏');
                }
            };

            // Initialize camera verification
            const initializeCameraVerification = async () => {
                console.log('üé• Initializing camera for verification...');
                setCameraVerificationMessage('–ó–∞–ø—É—Å–∫ –∫–∞–º–µ—Ä—ã...');

                try {
                    // Request camera access
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: {
                            width: { ideal: 640 },
                            height: { ideal: 480 },
                            facingMode: 'user'
                        },
                        audio: false
                    });

                    // Store stream reference
                    cameraStream = stream;

                    // Attach stream to both setup video and main camera video
                    const setupVideoElement = document.getElementById('setupCameraVideo');
                    const mainVideoElement = document.getElementById('cameraVideo');

                    if (setupVideoElement) {
                        setupVideoElement.srcObject = stream;
                        console.log('üìπ Stream attached to setup video');
                    }
                    if (mainVideoElement) {
                        mainVideoElement.srcObject = stream;
                        console.log('üìπ Stream attached to main video');
                    }

                    setCameraReady(true);
                    setCameraVerificationMessage('–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–Ω–∞. –ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π...');

                    // Wait for video to actually start playing
                    if (setupVideoElement) {
                        await new Promise((resolve) => {
                            if (setupVideoElement.readyState >= 2) {
                                console.log('‚úÖ Video already ready');
                                resolve();
                            } else {
                                setupVideoElement.onloadeddata = () => {
                                    console.log('‚úÖ Video loaded and ready');
                                    resolve();
                                };
                            }
                        });
                    }

                    // Load AI models if not already loaded
                    if (!blazefaceModel || !faceLandmarksDetector) {
                        setCameraVerificationMessage('–ó–∞–≥—Ä—É–∑–∫–∞ –º–æ–¥–µ–ª–µ–π —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –ª–∏—Ü...');
                        console.log('ü§ñ Loading AI models...');
                        const loaded = await loadAIModels();
                        if (!loaded) {
                            console.error('‚ùå Models failed to load');
                            setCameraVerificationMessage('‚ö†Ô∏è –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–æ–¥–µ–ª–µ–π. –ö–∞–º–µ—Ä–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç, –Ω–æ –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏—Ü–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.');
                            setCameraReady(true); // Still allow proceeding if models fail
                            setFaceDetected(true); // Allow proceeding even without face detection
                            return;
                        }
                        console.log('‚úÖ AI models loaded successfully');
                    }

                    setCameraVerificationMessage('–ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...');

                    // Give a small delay to ensure video is actually streaming frames
                    await new Promise(resolve => setTimeout(resolve, 500));

                    // Start face detection verification
                    console.log('üéØ Starting face verification');
                    startFaceVerification();
                } catch (error) {
                    console.error('‚ùå Camera initialization error:', error);
                    setCameraReady(false);
                    setCameraVerificationMessage('‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.');
                }
            };

            // Verify face positioning
            let verificationInterval = null;
            const startFaceVerification = () => {
                console.log('üë§ Starting face verification...');

                let detectionCount = 0;

                verificationInterval = setInterval(async () => {
                    const videoElement = document.getElementById('setupCameraVideo') || document.getElementById('cameraVideo');
                    if (!videoElement || !cameraStream) {
                        console.log('‚ö†Ô∏è Video element or stream not available');
                        return;
                    }

                    // Check if video is actually playing
                    if (videoElement.readyState < 2) {
                        console.log('‚è≥ Video not ready yet, readyState:', videoElement.readyState);
                        return;
                    }

                    try {
                        detectionCount++;
                        console.log(`üîç Face detection attempt #${detectionCount}`);

                        // Detect faces using Blazeface
                        const predictions = await blazefaceModel.estimateFaces(videoElement, false);
                        const numFaces = predictions ? predictions.length : 0;

                        console.log(`üë• Detected ${numFaces} face(s)`);
                        setFaceCount(numFaces);

                        // Check if we're in camera setup mode by looking for the setup video element
                        const isInSetupMode = document.getElementById('setupCameraVideo') !== null;

                        // During camera setup (before test starts)
                        if (isInSetupMode) {
                            console.log('üì∏ In setup mode');
                            if (numFaces > 0) {
                                console.log('‚úÖ Face detected in setup mode!');
                                setFaceDetected(true);
                                setCameraVerificationMessage('‚úÖ –õ–∏—Ü–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ! –í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å.');
                            } else {
                                console.log('‚ö†Ô∏è No face in setup mode');
                                setFaceDetected(false);
                                setCameraVerificationMessage('‚ö†Ô∏è –õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ—Å—å –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π.');
                            }
                        }
                        // During test - auto-pause/resume based on face count
                        else {
                            console.log('üß™ In test mode');
                            if (numFaces === 0) {
                                // No face detected - pause test
                                console.log('‚ö†Ô∏è No face detected - pausing test');
                                setIsPaused(true);
                                setPauseReason('no_face');
                            } else if (numFaces > 1) {
                                // Multiple faces detected - pause test
                                console.log(`‚ö†Ô∏è ${numFaces} faces detected - pausing test`);
                                setIsPaused(true);
                                setPauseReason('multiple_faces');
                            } else {
                                // Exactly 1 face - resume if paused due to face issues
                                console.log('‚úÖ Single face detected - OK');
                                setIsPaused(false);
                                setPauseReason('');
                            }
                        }
                    } catch (error) {
                        console.error('‚ùå Face detection error:', error);
                        console.error('Error details:', error.message, error.stack);
                    }
                }, 1000); // Check every second
            };

            // Proceed to test after camera verification
            const proceedToTest = async () => {
                console.log('‚ñ∂Ô∏è Proceeding to test...');

                // Enter fullscreen mode FIRST
                console.log('üñ•Ô∏è Entering fullscreen mode...');
                await enterFullscreen();

                // Show the main camera feed in the corner
                const cameraFeed = document.getElementById('cameraFeed');
                if (cameraFeed) {
                    cameraFeed.classList.add('active');
                }

                setShowCameraSetup(false);
                setLoading(true);

                // Load test questions
                await loadQuestions();

                // Continue face verification during test (don't stop the interval)
                // The face verification will now auto-pause/resume the test

                // ü§ñ START AI PROCTORING
                console.log('ü§ñ Starting AI proctoring');
                await startAIProctoring(parseInt(userTestId));
            };

            if (loading) {
                return (
                    <div className="test-container">
                        <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                );
            }

            // Show self-assessment FIRST, before test starts
            if (showSelfAssessment && !selfAssessmentSubmitted && competencies.length > 0) {
                return (
                    <div className="test-container">
                        <div style={{
                            marginTop: '20px',
                            padding: '25px',
                            background: '#fff',
                            borderRadius: '12px',
                            border: '2px solid #f5576c',
                            boxShadow: '0 4px 12px rgba(245, 87, 108, 0.1)'
                        }}>
                            <h3 style={{color: '#f5576c', marginBottom: '15px', fontSize: '24px', textAlign: 'center'}}>
                                ‚≠ê –°–∞–º–æ–æ—Ü–µ–Ω–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π
                            </h3>
                            <p style={{color: '#666', marginBottom: '25px', fontSize: '16px', textAlign: 'center'}}>
                                –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç–µ—Å—Ç–∞ –æ—Ü–µ–Ω–∏—Ç–µ —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –≤–ª–∞–¥–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º–∏ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10
                            </p>
                            <p style={{color: '#999', marginBottom: '25px', fontSize: '14px', textAlign: 'center', fontStyle: 'italic'}}>
                                1 = –Ω–∞—á–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å, 10 = —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
                            </p>

                            {competencies.map(comp => (
                                <div key={comp.id} style={{
                                    marginBottom: '25px',
                                    padding: '20px',
                                    background: '#f8f9fa',
                                    borderRadius: '10px'
                                }}>
                                    <div style={{
                                        display: 'flex',
                                        justifyContent: 'space-between',
                                        alignItems: 'center',
                                        marginBottom: '15px',
                                        flexWrap: 'wrap'
                                    }}>
                                        <div style={{flex: 1, minWidth: '200px'}}>
                                            <strong style={{fontSize: '16px', color: '#333'}}>
                                                {comp.name}
                                            </strong>
                                            <span style={{
                                                marginLeft: '10px',
                                                padding: '4px 10px',
                                                background: '#f5576c',
                                                color: 'white',
                                                borderRadius: '12px',
                                                fontSize: '12px',
                                                fontWeight: 'bold'
                                            }}>
                                                CORE {comp.importance}%
                                            </span>
                                        </div>
                                        {selfRatings[comp.id] && (
                                            <div style={{
                                                marginTop: '8px',
                                                padding: '6px 12px',
                                                background: '#1DB584',
                                                color: 'white',
                                                borderRadius: '8px',
                                                fontSize: '14px',
                                                fontWeight: 'bold'
                                            }}>
                                                –û—Ü–µ–Ω–∫–∞: {selfRatings[comp.id]}/10
                                            </div>
                                        )}
                                    </div>

                                    <div style={{
                                        display: 'flex',
                                        gap: '8px',
                                        flexWrap: 'wrap',
                                        justifyContent: 'center'
                                    }}>
                                        {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rating => (
                                            <button
                                                key={rating}
                                                onClick={() => {
                                                    setSelfRatings({...selfRatings, [comp.id]: rating});
                                                }}
                                                style={{
                                                    width: '45px',
                                                    height: '45px',
                                                    borderRadius: '8px',
                                                    border: selfRatings[comp.id] === rating
                                                        ? '3px solid #f5576c'
                                                        : '2px solid #ddd',
                                                    background: selfRatings[comp.id] === rating
                                                        ? '#f5576c'
                                                        : 'white',
                                                    color: selfRatings[comp.id] === rating ? 'white' : '#333',
                                                    fontSize: '16px',
                                                    fontWeight: 'bold',
                                                    cursor: 'pointer',
                                                    transition: 'all 0.2s'
                                                }}
                                            >
                                                {rating}
                                            </button>
                                        ))}
                                    </div>
                                </div>
                            ))}

                            <button
                                className="btn"
                                onClick={submitSelfAssessment}
                                style={{
                                    width: '100%',
                                    marginTop: '20px',
                                    padding: '15px',
                                    fontSize: '18px',
                                    fontWeight: 'bold',
                                    background: Object.keys(selfRatings).length === competencies.length
                                        ? 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)'
                                        : '#ccc',
                                    cursor: Object.keys(selfRatings).length === competencies.length
                                        ? 'pointer'
                                        : 'not-allowed'
                                }}
                                disabled={Object.keys(selfRatings).length !== competencies.length}
                            >
                                –ù–∞—á–∞—Ç—å —Ç–µ—Å—Ç ({Object.keys(selfRatings).length}/{competencies.length} –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π –æ—Ü–µ–Ω–µ–Ω–æ)
                            </button>
                        </div>
                    </div>
                );
            }

            // Show camera setup/verification screen
            if (showCameraSetup) {
                return (
                    <div className="test-container" style={{maxWidth: '900px', margin: '0 auto'}}>
                        <div style={{
                            marginTop: '20px',
                            padding: '30px',
                            background: '#fff',
                            borderRadius: '16px',
                            border: `3px solid ${faceDetected ? '#1DB584' : '#ff9800'}`,
                            boxShadow: '0 6px 20px rgba(0, 0, 0, 0.1)',
                            transition: 'border-color 0.3s ease'
                        }}>
                            <h2 style={{
                                color: '#333',
                                marginBottom: '10px',
                                fontSize: '28px',
                                textAlign: 'center',
                                fontWeight: 'bold'
                            }}>
                                üì∏ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–º–µ—Ä—ã
                            </h2>

                            <p style={{
                                color: '#666',
                                marginBottom: '25px',
                                fontSize: '16px',
                                textAlign: 'center',
                                lineHeight: '1.6'
                            }}>
                                –ü–µ—Ä–µ–¥ –Ω–∞—á–∞–ª–æ–º —Ç–µ—Å—Ç–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –∫–∞–º–µ—Ä—É –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
                            </p>

                            {/* Camera Preview */}
                            <div style={{
                                position: 'relative',
                                width: '100%',
                                maxWidth: '640px',
                                margin: '0 auto 25px',
                                borderRadius: '12px',
                                overflow: 'hidden',
                                border: `4px solid ${faceDetected ? '#1DB584' : cameraReady ? '#ff9800' : '#ddd'}`,
                                boxShadow: '0 4px 12px rgba(0, 0, 0, 0.15)',
                                background: '#000',
                                transition: 'border-color 0.3s ease'
                            }}>
                                {/* Setup video preview - will show the camera stream */}
                                <video
                                    id="setupCameraVideo"
                                    autoPlay
                                    playsInline
                                    muted
                                    style={{
                                        width: '100%',
                                        height: 'auto',
                                        display: 'block',
                                        transform: 'scaleX(-1)' // Mirror the video
                                    }}
                                />

                                {/* Overlay with face detection indicator */}
                                <div style={{
                                    position: 'absolute',
                                    top: '15px',
                                    left: '15px',
                                    right: '15px',
                                    padding: '12px 20px',
                                    background: faceDetected
                                        ? 'rgba(29, 181, 132, 0.95)'
                                        : cameraReady
                                            ? 'rgba(255, 152, 0, 0.95)'
                                            : 'rgba(158, 158, 158, 0.95)',
                                    borderRadius: '8px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '10px',
                                    transition: 'background 0.3s ease'
                                }}>
                                    <span style={{fontSize: '24px'}}>
                                        {faceDetected ? '‚úÖ' : cameraReady ? '‚ö†Ô∏è' : '‚è≥'}
                                    </span>
                                    <span style={{
                                        color: 'white',
                                        fontWeight: 'bold',
                                        fontSize: '16px'
                                    }}>
                                        {cameraVerificationMessage}
                                    </span>
                                </div>
                            </div>

                            {/* Instructions */}
                            <div style={{
                                background: '#f8f9fa',
                                padding: '20px',
                                borderRadius: '10px',
                                marginBottom: '25px'
                            }}>
                                <h4 style={{
                                    color: '#333',
                                    marginBottom: '12px',
                                    fontSize: '18px',
                                    fontWeight: 'bold'
                                }}>
                                    üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –Ω–∞—Å—Ç—Ä–æ–π–∫–µ:
                                </h4>
                                <ul style={{
                                    color: '#666',
                                    fontSize: '15px',
                                    lineHeight: '1.8',
                                    marginLeft: '20px',
                                    listStyle: 'disc'
                                }}>
                                    <li>–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–∞—à–µ –ª–∏—Ü–æ —Ö–æ—Ä–æ—à–æ –æ—Å–≤–µ—â–µ–Ω–æ</li>
                                    <li>–†–∞—Å–ø–æ–ª–æ–∂–∏—Ç–µ—Å—å –≤ —Ü–µ–Ω—Ç—Ä–µ –∫–∞–¥—Ä–∞</li>
                                    <li>–°–æ—Ö—Ä–∞–Ω—è–π—Ç–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω–æ–µ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–µ –æ—Ç –∫–∞–º–µ—Ä—ã (40-60 —Å–º)</li>
                                    <li>–£–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –∫–∞–¥—Ä–∞</li>
                                    <li>–î–æ–∂–¥–∏—Ç–µ—Å—å –ø–æ—è–≤–ª–µ–Ω–∏—è –∑–µ–ª–µ–Ω–æ–π —Ä–∞–º–∫–∏ (‚úÖ –õ–∏—Ü–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ)</li>
                                </ul>
                            </div>

                            {/* Warning about proctoring */}
                            <div style={{
                                background: '#fff3cd',
                                padding: '15px',
                                borderRadius: '8px',
                                marginBottom: '25px',
                                border: '2px solid #ffc107'
                            }}>
                                <p style={{
                                    color: '#856404',
                                    fontSize: '14px',
                                    margin: 0,
                                    display: 'flex',
                                    alignItems: 'center',
                                    gap: '10px'
                                }}>
                                    <span style={{fontSize: '20px'}}>‚ö†Ô∏è</span>
                                    <span>
                                        <strong>–í–Ω–∏–º–∞–Ω–∏–µ:</strong> –í–æ –≤—Ä–µ–º—è —Ç–µ—Å—Ç–∞ –±—É–¥–µ—Ç –≤–µ—Å—Ç–∏—Å—å –≤–∏–¥–µ–æ–Ω–∞–±–ª—é–¥–µ–Ω–∏–µ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º AI
                                        –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è —á–µ—Å—Ç–Ω–æ—Å—Ç–∏ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è —Ç–µ—Å—Ç–∞. –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏–µ —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏–∏ –±—É–¥—É—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å—Å—è
                                        –Ω–∞ –∞–Ω–∞–ª–∏–∑.
                                    </span>
                                </p>
                            </div>

                            {/* Continue button */}
                            <button
                                onClick={proceedToTest}
                                disabled={!faceDetected}
                                style={{
                                    width: '100%',
                                    padding: '18px',
                                    fontSize: '18px',
                                    fontWeight: 'bold',
                                    background: faceDetected
                                        ? 'linear-gradient(135deg, #1DB584 0%, #10b981 100%)'
                                        : '#ccc',
                                    color: 'white',
                                    border: 'none',
                                    borderRadius: '10px',
                                    cursor: faceDetected ? 'pointer' : 'not-allowed',
                                    transition: 'all 0.3s ease',
                                    boxShadow: faceDetected ? '0 4px 12px rgba(29, 181, 132, 0.3)' : 'none',
                                    opacity: faceDetected ? 1 : 0.6
                                }}
                            >
                                {faceDetected ? '‚úÖ –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∫ —Ç–µ—Å—Ç—É' : '‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –ª–∏—Ü–∞...'}
                            </button>

                            {!cameraReady && (
                                <p style={{
                                    marginTop: '15px',
                                    textAlign: 'center',
                                    color: '#d32f2f',
                                    fontSize: '14px'
                                }}>
                                    –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –±—Ä–∞—É–∑–µ—Ä–∞ –∏ –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                </p>
                            )}
                        </div>
                    </div>
                );
            }

            if (completed) {
                console.log('üìä RENDERING COMPLETION PAGE');
                console.log('  - showSelfAssessment:', showSelfAssessment);
                console.log('  - competencies.length:', competencies.length);
                console.log('  - selfAssessmentSubmitted:', selfAssessmentSubmitted);
                console.log('  - Will show self-assessment?', showSelfAssessment && !selfAssessmentSubmitted && competencies.length > 0);

                return (
                    <div className="test-container">
                        <div className="completion">
                            <h2>–¢–µ—Å—Ç –∑–∞–≤–µ—Ä—à–µ–Ω! üéâ</h2>
                            <div className="score-display">
                                {result.score}/{result.max_score}
                            </div>
                            <div className="level-badge">{result.level}</div>

                            {!result.recommendation && (
                                <div style={{
                                    marginTop: '30px',
                                    padding: '20px',
                                    background: '#f0fdf7',
                                    borderRadius: '12px',
                                    border: '2px solid #1DB584'
                                }}>
                                    <h3 style={{color: '#1DB584', marginBottom: '12px'}}>
                                        ‚è≥ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è AI —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏...
                                    </h3>
                                    <p style={{color: '#666', fontSize: '16px'}}>
                                        –ü–æ–∂–∞–ª—É–π—Å—Ç–∞ –ø–æ–¥–æ–∂–¥–∏—Ç–µ, Claude –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç –≤–∞—à–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã
                                    </p>
                                </div>
                            )}

                            {result.recommendation && (
                                <div style={{
                                    marginTop: '30px',
                                    padding: '20px',
                                    background: '#f0fdf7',
                                    borderRadius: '12px',
                                    border: '2px solid #1DB584'
                                }}>
                                    <h3 style={{color: '#1DB584', marginBottom: '12px'}}>
                                        üí° –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è AI
                                    </h3>
                                    <p style={{color: '#333', fontSize: '16px', lineHeight: '1.6', whiteSpace: 'pre-wrap'}}>
                                        {result.recommendation}
                                    </p>
                                </div>
                            )}

                            {/* Self-Assessment moved to BEFORE test - this section no longer needed */}
                            {false && showSelfAssessment && !selfAssessmentSubmitted && competencies.length > 0 && (
                                <div style={{
                                    marginTop: '30px',
                                    padding: '25px',
                                    background: '#fff',
                                    borderRadius: '12px',
                                    border: '2px solid #f5576c',
                                    boxShadow: '0 4px 12px rgba(245, 87, 108, 0.1)'
                                }}>
                                    <h3 style={{color: '#f5576c', marginBottom: '15px', fontSize: '20px'}}>
                                        ‚≠ê –°–∞–º–æ–æ—Ü–µ–Ω–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–π
                                    </h3>
                                    <p style={{color: '#666', marginBottom: '25px', fontSize: '15px'}}>
                                        –û—Ü–µ–Ω–∏—Ç–µ —Å–≤–æ–π —É—Ä–æ–≤–µ–Ω—å –≤–ª–∞–¥–µ–Ω–∏—è –æ—Å–Ω–æ–≤–Ω—ã–º–∏ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º–∏ –ø–æ —à–∫–∞–ª–µ –æ—Ç 1 –¥–æ 10
                                    </p>

                                    {competencies.map(comp => (
                                        <div key={comp.id} style={{
                                            marginBottom: '25px',
                                            padding: '20px',
                                            background: '#f8f9fa',
                                            borderRadius: '10px'
                                        }}>
                                            <div style={{
                                                display: 'flex',
                                                justifyContent: 'space-between',
                                                alignItems: 'center',
                                                marginBottom: '15px',
                                                flexWrap: 'wrap'
                                            }}>
                                                <div style={{flex: 1, minWidth: '200px'}}>
                                                    <strong style={{fontSize: '15px', color: '#333'}}>
                                                        {comp.name}
                                                    </strong>
                                                    <span style={{
                                                        marginLeft: '10px',
                                                        padding: '4px 10px',
                                                        background: '#f5576c',
                                                        color: 'white',
                                                        borderRadius: '12px',
                                                        fontSize: '12px',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        CORE {comp.importance}%
                                                    </span>
                                                </div>
                                                {selfRatings[comp.id] && (
                                                    <div style={{
                                                        marginTop: '8px',
                                                        padding: '6px 14px',
                                                        background: '#1DB584',
                                                        color: 'white',
                                                        borderRadius: '20px',
                                                        fontSize: '14px',
                                                        fontWeight: 'bold'
                                                    }}>
                                                        –í—ã–±—Ä–∞–Ω–æ: {selfRatings[comp.id]}/10
                                                    </div>
                                                )}
                                            </div>

                                            <div style={{
                                                display: 'flex',
                                                gap: '8px',
                                                flexWrap: 'wrap',
                                                justifyContent: 'center'
                                            }}>
                                                {[1, 2, 3, 4, 5, 6, 7, 8, 9, 10].map(rating => (
                                                    <button
                                                        key={rating}
                                                        onClick={() => setSelfRatings({...selfRatings, [comp.id]: rating})}
                                                        style={{
                                                            minWidth: '45px',
                                                            height: '45px',
                                                            borderRadius: '8px',
                                                            border: '2px solid',
                                                            borderColor: selfRatings[comp.id] === rating ? '#f5576c' : '#ddd',
                                                            background: selfRatings[comp.id] === rating
                                                                ? 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)'
                                                                : 'white',
                                                            color: selfRatings[comp.id] === rating ? 'white' : '#333',
                                                            fontSize: '16px',
                                                            fontWeight: 'bold',
                                                            cursor: 'pointer',
                                                            transition: 'all 0.2s',
                                                            transform: selfRatings[comp.id] === rating ? 'scale(1.1)' : 'scale(1)'
                                                        }}
                                                        onMouseEnter={(e) => {
                                                            if (selfRatings[comp.id] !== rating) {
                                                                e.target.style.borderColor = '#f5576c';
                                                                e.target.style.background = '#fff5f7';
                                                            }
                                                        }}
                                                        onMouseLeave={(e) => {
                                                            if (selfRatings[comp.id] !== rating) {
                                                                e.target.style.borderColor = '#ddd';
                                                                e.target.style.background = 'white';
                                                            }
                                                        }}
                                                    >
                                                        {rating}
                                                    </button>
                                                ))}
                                            </div>
                                        </div>
                                    ))}

                                    <button
                                        className="btn"
                                        onClick={submitSelfAssessment}
                                        style={{
                                            width: '100%',
                                            marginTop: '20px',
                                            padding: '15px',
                                            fontSize: '16px',
                                            fontWeight: 'bold',
                                            background: Object.keys(selfRatings).length === competencies.length
                                                ? 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)'
                                                : '#ccc',
                                            cursor: Object.keys(selfRatings).length === competencies.length
                                                ? 'pointer'
                                                : 'not-allowed'
                                        }}
                                        disabled={Object.keys(selfRatings).length !== competencies.length}
                                    >
                                        –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–∞–º–æ–æ—Ü–µ–Ω–∫—É ({Object.keys(selfRatings).length}/{competencies.length})
                                    </button>
                                </div>
                            )}

                            <button
                                className="btn"
                                onClick={() => window.location.href = '/'}
                                style={{marginTop: '30px'}}
                            >
                                –ù–∞ –≥–ª–∞–≤–Ω—É—é
                            </button>
                        </div>
                    </div>
                );
            }

            // Don't render test if questions aren't loaded yet
            if (!questions || questions.length === 0) {
                return (
                    <div className="test-container">
                        <div className="loading">–ó–∞–≥—Ä—É–∑–∫–∞ –≤–æ–ø—Ä–æ—Å–æ–≤...</div>
                    </div>
                );
            }

            const currentQuestion = questions[currentIndex];
            const overallProgress = progress ?
                ((progress.total.answered / progress.total.total) * 100) : 0;

            return (
                <div className="test-container">
                    {/* Pause Overlay */}
                    {isPaused && (
                        <div style={{
                            position: 'fixed',
                            top: 0,
                            left: 0,
                            right: 0,
                            bottom: 0,
                            background: 'rgba(0, 0, 0, 0.95)',
                            zIndex: 10000,
                            display: 'flex',
                            alignItems: 'center',
                            justifyContent: 'center',
                            backdropFilter: 'blur(10px)'
                        }}>
                            <div style={{
                                background: 'white',
                                padding: '50px',
                                borderRadius: '20px',
                                maxWidth: '600px',
                                textAlign: 'center',
                                boxShadow: '0 20px 60px rgba(0, 0, 0, 0.3)',
                                border: '3px solid #ff9800'
                            }}>
                                <div style={{fontSize: '80px', marginBottom: '20px'}}>
                                    {pauseReason === 'no_face' ? 'üë§' : pauseReason === 'multiple_faces' ? 'üë•' : 'üñ•Ô∏è'}
                                </div>
                                <h2 style={{
                                    color: '#ff9800',
                                    fontSize: '32px',
                                    marginBottom: '20px',
                                    fontWeight: 'bold'
                                }}>
                                    ‚è∏Ô∏è –¢–µ—Å—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
                                </h2>
                                <p style={{
                                    color: '#333',
                                    fontSize: '20px',
                                    lineHeight: '1.6',
                                    marginBottom: '30px'
                                }}>
                                    {pauseReason === 'no_face' && (
                                        <>
                                            <strong>–õ–∏—Ü–æ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ</strong><br />
                                            –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–µ—Ä–Ω–∏—Ç–µ—Å—å –ø–µ—Ä–µ–¥ –∫–∞–º–µ—Ä–æ–π.<br />
                                            –¢–µ—Å—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –≤—ã –æ–∫–∞–∂–µ—Ç–µ—Å—å –≤ –∫–∞–¥—Ä–µ.
                                        </>
                                    )}
                                    {pauseReason === 'multiple_faces' && (
                                        <>
                                            <strong>–û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —á–µ–ª–æ–≤–µ–∫</strong><br />
                                            –í –∫–∞–¥—Ä–µ –¥–æ–ª–∂–µ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —É—á–∞—Å—Ç–Ω–∏–∫.<br />
                                            –¢–µ—Å—Ç –≤–æ–∑–æ–±–Ω–æ–≤–∏—Ç—Å—è, –∫–æ–≥–¥–∞ –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –æ–¥–∏–Ω —á–µ–ª–æ–≤–µ–∫.
                                        </>
                                    )}
                                    {pauseReason === 'fullscreen' && (
                                        <>
                                            <strong>–¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º</strong><br />
                                            –¢–µ—Å—Ç –¥–æ–ª–∂–µ–Ω –ø—Ä–æ—Ö–æ–¥–∏—Ç—å –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ.<br />
                                            <button
                                                onClick={enterFullscreen}
                                                style={{
                                                    marginTop: '20px',
                                                    padding: '15px 40px',
                                                    fontSize: '18px',
                                                    fontWeight: 'bold',
                                                    background: 'linear-gradient(135deg, #1DB584 0%, #10b981 100%)',
                                                    color: 'white',
                                                    border: 'none',
                                                    borderRadius: '10px',
                                                    cursor: 'pointer',
                                                    boxShadow: '0 4px 12px rgba(29, 181, 132, 0.3)'
                                                }}
                                            >
                                                –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω—ã–π —Ä–µ–∂–∏–º
                                            </button>
                                        </>
                                    )}
                                </p>
                                <div style={{
                                    background: '#f8f9fa',
                                    padding: '15px',
                                    borderRadius: '10px',
                                    marginTop: '20px'
                                }}>
                                    <p style={{
                                        color: '#666',
                                        fontSize: '14px',
                                        margin: 0
                                    }}>
                                        ‚è±Ô∏è –¢–∞–π–º–µ—Ä –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω ‚Ä¢ –û–±–Ω–∞—Ä—É–∂–µ–Ω–æ –ª–∏—Ü: {faceCount}
                                    </p>
                                </div>
                            </div>
                        </div>
                    )}

                    <div className="progress">
                        <div className="progress-bar">
                            <div className="progress-fill" style={{width: `${overallProgress}%`}}></div>
                        </div>
                        <div className="progress-text">
                            <span>–í–æ–ø—Ä–æ—Å {currentIndex + 1} –∏–∑ {questions.length}</span>
                            <span>
                                –û—Ç–≤–µ—á–µ–Ω–æ: {progress?.total.answered || 0}/{progress?.total.total || 24}
                            </span>
                        </div>
                    </div>

                    <div className="question">
                        <div className="question-header">
                            <span className="question-number">
                                –í–æ–ø—Ä–æ—Å {currentIndex + 1}
                            </span>
                            <span className={`question-level ${currentQuestion.level}`}>
                                {currentQuestion.level}
                            </span>
                        </div>

                        <div className="topic-name">
                            üìö {currentQuestion.topic_name}
                        </div>

                        <div className="question-text">
                            {currentQuestion.question_text}
                        </div>

                        <div className="options">
                            {currentQuestion.options.map((option, index) => (
                                <div
                                    key={index}
                                    className={`option ${selectedAnswer === index + 1 ? 'selected' : ''}`}
                                    onClick={() => !currentQuestion.is_answered && !isPaused && setSelectedAnswer(index + 1)}
                                    style={{opacity: isPaused ? 0.5 : 1, cursor: isPaused ? 'not-allowed' : 'pointer'}}
                                >
                                    {option}
                                </div>
                            ))}
                        </div>

                        <button
                            className="btn"
                            onClick={handleAnswer}
                            disabled={selectedAnswer === null || loading || currentQuestion.is_answered || isPaused}
                        >
                            {loading ? '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞...' :
                             currentQuestion.is_answered ? '–£–∂–µ –æ—Ç–≤–µ—á–µ–Ω' :
                             isPaused ? '‚è∏Ô∏è –¢–µ—Å—Ç –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω' :
                             (currentIndex < questions.length - 1 ? '–°–ª–µ–¥—É—é—â–∏–π –≤–æ–ø—Ä–æ—Å' : '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç')}
                        </button>
                    </div>

                    {progress && progress.competencies && (
                        <div className="competencies-stats">
                            <h3>üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –ø–æ –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏—è–º</h3>
                            {progress.competencies.map(comp => (
                                <div key={comp.id} className="competency-stat">
                                    <span className="competency-name">{comp.name}</span>
                                    <span className="competency-progress">
                                        {comp.answered}/{comp.correct}/{comp.total}
                                    </span>
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>