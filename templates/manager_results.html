<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager Panel - Результаты отдела</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: white;
            padding: 20px 40px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header h1 {
            color: #f5576c;
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
        }

        .btn-primary {
            background: #f5576c;
            color: white;
        }

        .btn-primary:hover {
            background: #f093fb;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            border-left: 4px solid #f5576c;
        }

        .stat-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 800;
            color: #f5576c;
        }

        .stat-detail {
            font-size: 13px;
            color: #999;
            margin-top: 8px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 700;
            color: #333;
        }

        .filters {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .filter-label {
            font-size: 13px;
            font-weight: 600;
            color: #666;
        }

        .filter-input,
        .filter-select {
            padding: 10px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: #f5576c;
        }

        .results-table-wrapper {
            overflow-x: auto;
        }

        .results-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 1200px;
        }

        .results-table thead {
            background: #f8f9fa;
            position: sticky;
            top: 70px;
            z-index: 50;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .results-table thead::after {
            content: '';
            position: absolute;
            left: 0;
            right: 0;
            bottom: -1px;
            height: 1px;
            background: #f8f9fa;
        }

        .results-table tbody tr:first-child td {
            border-top: 2px solid #e0e0e0;
        }

        .results-table th {
            padding: 15px 12px;
            text-align: left;
            font-weight: 700;
            color: #333;
            border-bottom: 2px solid #e0e0e0;
            font-size: 13px;
            text-transform: uppercase;
            background: #f8f9fa;
            position: relative;
            z-index: 51;
        }

        .results-table td {
            padding: 12px;
            border-bottom: 1px solid #f0f0f0;
            font-size: 14px;
        }

        .results-table tbody tr {
            transition: all 0.2s;
            background: white;
        }

        .results-table tbody tr:hover {
            background: #f8f9fa;
        }

        .level-badge {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .level-senior {
            background: #fff5f5;
            color: #e53e3e;
        }

        .level-middle {
            background: #fffaf0;
            color: #dd6b20;
        }

        .level-junior {
            background: #f0fff4;
            color: #38a169;
        }

        .score-display {
            font-weight: 700;
            font-size: 16px;
        }

        .action-btn {
            background: #f5576c;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .action-btn:hover {
            background: #f093fb;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 25px 30px;
            border-bottom: 2px solid #f0f0f0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .modal-title {
            font-size: 22px;
            font-weight: 700;
            color: #333;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #999;
            line-height: 1;
            padding: 0;
        }

        .modal-close:hover {
            color: #333;
        }

        .modal-body {
            padding: 30px;
        }

        .detail-section {
            margin-bottom: 30px;
        }

        .detail-section h3 {
            font-size: 18px;
            font-weight: 700;
            color: #f5576c;
            margin-bottom: 15px;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .detail-item {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .detail-label {
            font-size: 12px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
        }

        .detail-value {
            font-size: 16px;
            color: #333;
            font-weight: 500;
        }

        .question-item {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 15px;
        }

        .question-text {
            font-size: 15px;
            font-weight: 600;
            color: #333;
            flex: 1;
        }

        .question-result {
            font-size: 24px;
            margin-left: 15px;
        }

        .question-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 15px;
        }

        .option {
            padding: 12px 15px;
            border-radius: 8px;
            background: white;
            border: 2px solid #e0e0e0;
        }

        .option.correct {
            background: #f0fff4;
            border-color: #38a169;
        }

        .option.incorrect {
            background: #fff5f5;
            border-color: #e53e3e;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .empty-state-text {
            font-size: 18px;
            font-weight: 600;
        }

        .loader {
            text-align: center;
            padding: 40px;
            color: #f5576c;
            font-weight: 600;
        }

        .ai-recommendation {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .ai-recommendation h4 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .ai-recommendation p {
            font-size: 14px;
            line-height: 1.6;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>📋 Результаты тестов вашего отдела</h1>
        <div class="header-actions">
            <button class="btn btn-primary" onclick="exportToCSV()">📥 Экспорт CSV</button>
            <a href="/manager/menu" class="btn btn-secondary">◀ Назад</a>
        </div>
    </div>

    <div class="container">
        <!-- Statistics -->
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-label">Всего тестов</div>
                <div class="stat-value" id="totalTests">0</div>
                <div class="stat-detail">Завершенных</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Средний балл</div>
                <div class="stat-value" id="avgScore">0%</div>
                <div class="stat-detail">По всем тестам</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Senior</div>
                <div class="stat-value" id="seniorCount">0</div>
                <div class="stat-detail">67%+ правильных</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Middle</div>
                <div class="stat-value" id="middleCount">0</div>
                <div class="stat-detail">34-66% правильных</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Junior</div>
                <div class="stat-value" id="juniorCount">0</div>
                <div class="stat-detail">0-33% правильных</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Среднее время</div>
                <div class="stat-value" id="avgDuration">0</div>
                <div class="stat-detail">Минут на тест</div>
            </div>
        </div>

        <!-- Filters -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">🔍 Фильтры</div>
                <button class="btn btn-secondary" onclick="resetFilters()">Сбросить</button>
            </div>
            <div class="filters">
                <div class="filter-group">
                    <label class="filter-label">Специализация</label>
                    <select class="filter-select" id="filterSpec" onchange="applyFilters()">
                        <option value="">Все специализации</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Уровень</label>
                    <select class="filter-select" id="filterLevel" onchange="applyFilters()">
                        <option value="">Все уровни</option>
                        <option value="Senior">Senior</option>
                        <option value="Middle">Middle</option>
                        <option value="Junior">Junior</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Дата от</label>
                    <input type="date" class="filter-input" id="filterDateFrom" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Дата до</label>
                    <input type="date" class="filter-input" id="filterDateTo" onchange="applyFilters()">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Поиск (имя, телефон)</label>
                    <input type="text" class="filter-input" id="filterSearch"
                           placeholder="Введите имя или телефон..."
                           onkeyup="debounceSearch()">
                </div>
            </div>
        </div>

        <!-- Results Table -->
        <div class="section">
            <div class="section-header">
                <div class="section-title">📊 Результаты (<span id="resultsCount">0</span>)</div>
            </div>
            <div class="results-table-wrapper">
                <table class="results-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Сотрудник</th>
                            <th>Телефон</th>
                            <th>Компания</th>
                            <th>Должность</th>
                            <th>Специализация</th>
                            <th>Балл</th>
                            <th>%</th>
                            <th>Уровень</th>
                            <th>Оценка</th>
                            <th>Время</th>
                            <th>Дата</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="resultsBody">
                        <tr>
                            <td colspan="13" class="loader">Загрузка...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal for detailed view -->
    <div class="modal" id="detailModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Детальный просмотр результата</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="loader">Загрузка...</div>
            </div>
        </div>
    </div>

    <script>
        let allResults = [];
        let allSpecializations = new Set();
        let searchTimeout;

        async function loadStatistics() {
            try {
                const token = sessionStorage.getItem("halyk_token");
                if (!token) {
                    console.error('No token found');
                    window.location.href = '/';
                    return;
                }

                const response = await fetch("/api/manager/results/stats", {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                if (data.status === 'success' && data.overall) {
                    document.getElementById('totalTests').textContent = data.overall.total_tests;
                    document.getElementById('avgScore').textContent = data.overall.avg_percentage + '%';
                    document.getElementById('seniorCount').textContent = data.by_level['Senior'] || 0;
                    document.getElementById('middleCount').textContent = data.by_level['Middle'] || 0;
                    document.getElementById('juniorCount').textContent = data.by_level['Junior'] || 0;
                    document.getElementById('avgDuration').textContent = data.overall.avg_duration_minutes;

                    // Populate specialization filter
                    const specFilter = document.getElementById('filterSpec');
                    data.by_specialization.forEach(spec => {
                        const option = document.createElement('option');
                        option.value = spec.name;
                        option.textContent = `${spec.name} (${spec.count})`;
                        specFilter.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading statistics:', error);
                document.getElementById('totalTests').textContent = '❌';
                document.getElementById('avgScore').textContent = 'Ошибка';
            }
        }

        async function loadResults() {
            try {
                const params = new URLSearchParams();

                const spec = document.getElementById('filterSpec').value;
                const level = document.getElementById('filterLevel').value;
                const dateFrom = document.getElementById('filterDateFrom').value;
                const dateTo = document.getElementById('filterDateTo').value;
                const search = document.getElementById('filterSearch').value;

                if (spec) params.append('specialization', spec);
                if (level) params.append('level', level);
                if (dateFrom) params.append('date_from', dateFrom);
                if (dateTo) params.append('date_to', dateTo);
                if (search) params.append('search', search);

                const token = sessionStorage.getItem("halyk_token");
                if (!token) {
                    console.error('No token found');
                    window.location.href = '/';
                    return;
                }

                const response = await fetch("/api/manager/results?" + params.toString(), {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();

                if (data.status === 'success' && data.results) {
                    allResults = data.results;
                    renderResults(data.results);
                } else {
                    throw new Error('Invalid response format');
                }
            } catch (error) {
                console.error('Error loading results:', error);
                document.getElementById('resultsBody').innerHTML =
                    `<tr><td colspan="12" class="empty-state"><div class="empty-state-icon">❌</div><div class="empty-state-text">Ошибка загрузки данных: ${error.message}</div></td></tr>`;
            }
        }

        function renderResults(results) {
            const tbody = document.getElementById('resultsBody');
            document.getElementById('resultsCount').textContent = results.length;

            if (results.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="13" class="empty-state">
                            <div class="empty-state-icon">📭</div>
                            <div class="empty-state-text">Нет результатов</div>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = results.map(result => {
                const completedDate = new Date(result.completed_at).toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                // Render rating badge
                let ratingHtml = '-';
                if (result.employee_rating) {
                    const ratingClass = result.employee_rating >= 8 ? 'level-senior' :
                                       result.employee_rating >= 5 ? 'level-middle' : 'level-junior';
                    const title = result.rating_comment ? `title="${result.rating_comment}"` : '';
                    ratingHtml = `<span class="level-badge ${ratingClass}" ${title}>⭐ ${result.employee_rating}/10</span>`;
                }

                return `
                    <tr>
                        <td>${result.test_id}</td>
                        <td><strong>${result.name} ${result.surname}</strong></td>
                        <td>${result.phone || '-'}</td>
                        <td>${result.company || '-'}</td>
                        <td>${result.job_title || '-'}</td>
                        <td>${result.specialization}</td>
                        <td class="score-display">${result.score}/${result.max_score}</td>
                        <td><strong>${result.percentage}%</strong></td>
                        <td><span class="level-badge level-${result.level.toLowerCase()}">${result.level}</span></td>
                        <td>${ratingHtml}</td>
                        <td>${result.duration_minutes ? result.duration_minutes + ' мин' : '-'}</td>
                        <td>${completedDate}</td>
                        <td><button class="action-btn" onclick="viewDetail(${result.test_id})">Детали</button></td>
                    </tr>
                `;
            }).join('');
        }

        async function viewDetail(testId) {
            document.getElementById('detailModal').classList.add('active');
            document.getElementById('modalBody').innerHTML = '<div class="loader">Загрузка...</div>';

            try {
                const token = sessionStorage.getItem("halyk_token");
                if (!token) {
                    throw new Error('No authentication token found');
                }

                const response = await fetch(`/api/manager/results/${testId}`, {
                    headers: { "Authorization": `Bearer ${token}` }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();

                const info = data.test_info;
                const percentage = ((info.score / info.max_score) * 100).toFixed(2);
                const level = percentage >= 67 ? 'Senior' : percentage >= 34 ? 'Middle' : 'Junior';

                let html = `
                    <div class="detail-section">
                        <h3>👤 Информация о сотруднике</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">ФИО</div>
                                <div class="detail-value">${info.name} ${info.surname}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Телефон</div>
                                <div class="detail-value">${info.phone || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Компания</div>
                                <div class="detail-value">${info.company || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Должность</div>
                                <div class="detail-value">${info.job_title || '-'}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Специализация</div>
                                <div class="detail-value">${info.specialization}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Профиль</div>
                                <div class="detail-value">${info.profile}</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>📊 Результаты теста</h3>
                        <div class="detail-grid">
                            <div class="detail-item">
                                <div class="detail-label">Балл</div>
                                <div class="detail-value" style="color: #f5576c; font-size: 24px; font-weight: 800;">${info.score}/${info.max_score}</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Процент</div>
                                <div class="detail-value" style="color: #f5576c; font-size: 24px; font-weight: 800;">${percentage}%</div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Уровень</div>
                                <div class="detail-value"><span class="level-badge level-${level.toLowerCase()}">${level}</span></div>
                            </div>
                            <div class="detail-item">
                                <div class="detail-label">Дата прохождения</div>
                                <div class="detail-value">${new Date(info.completed_at).toLocaleString('ru-RU')}</div>
                            </div>
                        </div>
                    </div>

                    <div class="detail-section">
                        <h3>❓ Ответы на вопросы</h3>
                `;

                // Group answers by competency
                const byCompetency = {};
                data.answers.forEach(ans => {
                    if (!byCompetency[ans.competency]) {
                        byCompetency[ans.competency] = [];
                    }
                    byCompetency[ans.competency].push(ans);
                });

                Object.keys(byCompetency).forEach(comp => {
                    html += `<h4 style="margin: 20px 0 15px 0; color: #f5576c; font-size: 16px;">📌 ${comp}</h4>`;

                    byCompetency[comp].forEach((ans, idx) => {
                        const isCorrect = ans.is_correct;
                        html += `
                            <div class="question-item">
                                <div class="question-header">
                                    <div class="question-text">
                                        <strong>${idx + 1}. ${ans.topic}</strong> [${ans.level}]<br>
                                        ${ans.question}
                                    </div>
                                    <div class="question-result">${isCorrect ? '✅' : '❌'}</div>
                                </div>
                                <div class="question-options">
                                    ${ans.options.map((opt, i) => {
                                        const optNum = i + 1;
                                        const isCorrectAnswer = optNum === ans.correct_answer;
                                        const isUserAnswer = optNum === ans.user_answer;

                                        let className = 'option';
                                        if (isUserAnswer && isCorrectAnswer) className = 'option correct';
                                        else if (isUserAnswer && !isCorrectAnswer) className = 'option incorrect';
                                        else if (isCorrectAnswer) className = 'option correct';

                                        let prefix = '';
                                        if (isUserAnswer) prefix = '👉 ';
                                        if (isCorrectAnswer) prefix += '✓ ';

                                        return `<div class="${className}">${prefix}${optNum}. ${opt}</div>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    });
                });

                html += '</div>';

                // AI Recommendation
                if (data.ai_recommendation && data.ai_recommendation.text) {
                    html += `
                        <div class="ai-recommendation">
                            <h4>🤖 AI Рекомендации (Claude)</h4>
                            <p>${data.ai_recommendation.text}</p>
                        </div>
                    `;
                }

                document.getElementById('modalBody').innerHTML = html;
            } catch (error) {
                console.error('Error loading detail:', error);
                document.getElementById('modalBody').innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">❌</div><div class="empty-state-text">Ошибка загрузки данных</div></div>';
            }
        }

        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        function applyFilters() {
            loadResults();
        }

        function resetFilters() {
            document.getElementById('filterSpec').value = '';
            document.getElementById('filterLevel').value = '';
            document.getElementById('filterDateFrom').value = '';
            document.getElementById('filterDateTo').value = '';
            document.getElementById('filterSearch').value = '';
            loadResults();
        }

        function debounceSearch() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters();
            }, 500);
        }

        function exportToCSV() {
            if (allResults.length === 0) {
                alert('Нет данных для экспорта');
                return;
            }

            const headers = ['ID', 'Имя', 'Фамилия', 'Телефон', 'Компания', 'Должность', 'Специализация',
                            'Балл', 'Макс балл', 'Процент', 'Уровень', 'Время (мин)', 'Дата'];

            let csv = headers.join(',') + '\n';

            allResults.forEach(result => {
                const row = [
                    result.test_id,
                    result.name,
                    result.surname,
                    result.phone || '',
                    result.company || '',
                    result.job_title || '',
                    result.specialization,
                    result.score,
                    result.max_score,
                    result.percentage,
                    result.level,
                    result.duration_minutes || '',
                    new Date(result.completed_at).toLocaleString('ru-RU')
                ].map(cell => {
                    const str = String(cell);
                    if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                        return '"' + str.replace(/"/g, '""') + '"';
                    }
                    return str;
                });
                csv += row.join(',') + '\n';
            });

            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);

            link.setAttribute('href', url);
            link.setAttribute('download', `hr_results_${Date.now()}.csv`);
            link.style.visibility = 'hidden';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Close modal on outside click
        document.getElementById('detailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        // Initialize
        loadStatistics();
        loadResults();
    </script>
</body>
</html>
